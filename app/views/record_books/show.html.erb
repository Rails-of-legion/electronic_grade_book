<h1>Record Book</h1>
<p>
  <strong>Student:</strong>
  <%= @record_book.user.name %>
</p>


  <%= simple_form_for :grade, url: record_book_path(@record_book, month: params[:month]), method: :get, html: { class: 'form-inline' } do |f| %>
    <%= f.input :selected_month, collection: Date::MONTHNAMES.compact.each_with_index.map { |name, i| [name, i+1] }, prompt: 'Выберите месяц', input_html: { onchange: 'this.form.submit();', name: 'month', class: 'form-control' } %>
    <%= hidden_field_tag :year, Time.now.year %>
  <% end %>

  <table class="table table-striped table-bordered table-hover">
    <thead>
      <tr>
        <th><%= Date::MONTHNAMES[@month.to_i] %></th>
        <% (1..Time.days_in_month(@month.to_i)).each do |day| %>
          <th><%= day %></th>
        <% end %>
      </tr>
    </thead>
    <tbody>
      <% @record_book.specialization.subjects.each do |subject| %>
      <tr>
        <td><%= subject.name %></td>
        <% (1..Time.days_in_month(@month.to_i)).each do |day| %>
          <td>
            <% date = Date.new(Time.current.year, @month.to_i, day) %>
            <% grade = subject.grades.find { |g| g.date == date } %>
            <% if grade %>
              <%= grade.grade %>
            <% end %>
          </td>
        <% end %>
      </tr>
    <% end %>
  </table>
    
    
    </tbody>
  </table>

  <% if current_user.has_role? :teacher %> 
    <%= simple_form_for Grade.new, url: {controller: "grades", action: "create"}, method: :post do |f| %>
    <%= f.input :date, collection: (1..Time.days_in_month(@month.to_i)), prompt: 'Выберите день', input_html: { class: 'form-control' } %>
    <%= f.input :subject_id, collection: @record_book.specialization.subjects.map { |subject| [subject.name, subject.id] }, prompt: 'Выберите предмет', input_html: { class: 'form-control' } %>
    <%= f.input :grade, collection: (1..5), prompt: 'Добавить оценку', input_html: { class: 'form-control' } %>
    <%= hidden_field_tag :month, @month %>
    <%= hidden_field_tag :year, Time.now.year %>
    <%= f.button :submit, 'Добавить оценку', class: 'btn btn-primary' %>
  <% end %> 
<% end %>

<% if current_user.has_role? :teacher %>
  <%= link_to 'Edit', edit_record_book_path(@record_book), class: 'btn btn-secondary' %> 
<% end %>
<% if current_user.has_role? :student %>
  <%= link_to 'Back', user_path(current_user), class: 'btn btn-light' %>
<% else %>
  <%= link_to 'Back', record_books_path, class: 'btn btn-light' %>
<% end %>
